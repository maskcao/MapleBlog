# 网站流量统计设置指南

本项目内置 Google Analytics（GA4）与百度统计脚本，无需后端。通过配置与环境变量控制在生产环境自动注入。

## 功能简介

- 仅生产环境加载：当 `PUBLIC_ENV=production` 时注入统计脚本
- ID 为空不加载：`SITE_INFO.GOOGLE_ANALYTICS_ID` / `SITE_INFO.BAIDU_ANALYTICS_ID` 留空即关闭
- 异步注入：不阻塞首屏渲染，脚本通过 `<script async>` 或动态创建方式加载
- 全局注入点：统一在基础布局 `BaseLayout.astro` 的 `<head>` 中插入

## 涉及代码

- `src/components/base/BaseLayout.astro`
  - 环境判断与脚本注入（仅在非开发环境且 ID 存在时加载）：
  ```astro
  ---
  import { isDevelopment } from "@lib/env";
  import { SITE_INFO } from "@lib/config";
  const googleAnalyticsId = SITE_INFO.GOOGLE_ANALYTICS_ID || "";
  const baiduAnalyticsId = SITE_INFO.BAIDU_ANALYTICS_ID || "";
  ---
  <!-- Google Analytics - 仅在生产环境加载 -->
  { !isDevelopment() && googleAnalyticsId && (
    <>
      <script async src={`https://www.googletagmanager.com/gtag/js?id=${googleAnalyticsId}`} />
      <script set:html={`
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);} 
        gtag('js', new Date());
        gtag('config', '${googleAnalyticsId}');
      `} />
    </>
  )}

  <!-- 百度统计 - 仅在生产环境加载 -->
  { !isDevelopment() && baiduAnalyticsId && (
    <script set:html={`
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?${baiduAnalyticsId}";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    `} />
  )}
  ```

- `src/lib/env.ts`
  - 环境变量读取与判断：
  ```ts
  export const NODE_ENV = import.meta.env.PUBLIC_ENV || 'development';
  export const isDevelopment = () => NODE_ENV === 'development';
  export const isProduction = () => NODE_ENV === 'production';
  ```

- `src/lib/config.ts`
  - 统计 ID 配置项：
  ```ts
  export const SITE_INFO = {
    GOOGLE_ANALYTICS_ID: 'G-XXXXXXX',  // 留空则不加载
    BAIDU_ANALYTICS_ID: 'XXXXXXXXXX',  // 留空则不加载
  } as const;
  ```

## 使用方法

- 配置统计 ID：编辑 `src/lib/config.ts`
  - GA4：`GOOGLE_ANALYTICS_ID`（示例 `G-XXXXXXXXXX`）
  - 百度统计：`BAIDU_ANALYTICS_ID`（在代码获取页 `hm.js?` 后的 16 位 ID）

- 设置环境变量：确保在生产部署环境设置
  - `PUBLIC_ENV=production`
  - 可在 `.env` 或平台环境变量面板（Vercel/Netlify）中配置

- 验证加载：
  - 查看源代码：搜索 `gtag` 或 `_hmt`
  - Network：过滤 `google-analytics.com`、`hm.baidu.com`，应看到对应请求

提示：如需停用，将 `SITE_INFO` 中对应 ID 置空即可；无需改动页面代码。